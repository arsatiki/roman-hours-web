<!doctype html>
<html>
<head>
<meta name="viewport" content="width=320, height=320, initial-scale=1, maximum-scale=1">
<style type="text/css">
#clock { 
	border: 1px solid black;
	border-radius: 50%;

	margin: 10px auto;
	width: 300px;
	height: 300px;
	
	position: relative;
}

#clock img {
	-webkit-transition: -webkit-transform 1s linear 0s;
	-webkit-transform-origin: 32px 32px;
	-webkit-transform: scale(0.01, 0.01);
	position: relative;
	left: 118px;
	top: 118px;
}
</style>
<script src="sun.js" type="application/javascript"></script>
<script type="application/javascript">

var TAU = 2 * Math.PI;

var latitude = 41.9, longitude = 12.5;

function getDefault(key, defaultv) {
	var v;
	v = localStorage.getItem(key);
	return (v !== null)? v * 1.0: defaultv;
}

function updatePosition(pos) {
	latitude = pos.coords.latitude;
	longitude = pos.coords.longitude;
	if (console)
		console.log("Updating lat: " + latitude + ", lon: " + longitude);
	localStorage.setItem("longitude", longitude);
	localStorage.setItem("latitude", latitude);
	tick();
}

function locate() {
	console.log("Locating");
	if ("localStorage" in window) {
		console.log("Checking local storage for previous location");
		latitude = getDefault("latitude", latitude);
		longitude = getDefault("longitude", longitude);
	}

	if (! "geolocation" in navigator) {
		console.log("No geolocation available, using defaults.");
	}
	navigator.geolocation.getCurrentPosition(updatePosition, errCallback,
		{maximumAge:60000, timeout:10000});
	navigator.geolocation.watchPosition(updatePosition, errCallback,
		{maximumAge:600000, timeout:100000});
	tick();
}

function errCallback(err) {
	console.log(err.code, err.message);
}

function angle(hour) {
	return TAU * hour / 12;
}

function setHand(hour) {
	var a = angle(hour);
	var h = document.getElementById('hand');
	h.style.WebkitTransform = "scale(0.225, 0.225) rotate(" + a + "rad)";
}

function tick() {
	var period = compute_period(latitude, longitude);
	var hour = 12 * (Date.now() - period.start) / period.duration;
	console.log("Setting hour to " + hour);
	setHand(hour);
	console.log("Latitude", latitude, ". Longitude", longitude);
}

setInterval(tick, 60000);

// Hide Safari top menu
window.addEventListener('load', function(){
	setTimeout(function() {
		window.scrollTo(0, 1);
	}, 0);
});

document.addEventListener('DOMContentLoaded', locate, false);

</script>
</head>
<body>
<div id="clock">
<img id="hand" src="clockhand.png">
</div>
</body>
</html>